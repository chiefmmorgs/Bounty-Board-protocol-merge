"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BountyService = void 0;
const ethers_1 = require("ethers");
const types_1 = require("../types");
/**
 * BountyService - Business logic for bounty operations
 * No UI logic, only contract interactions and validation
 */
class BountyService {
    constructor(config, signer, contractABI) {
        this.config = config;
        this.signer = signer;
        this.contract = new ethers_1.Contract(config.contracts.bountyRegistry, contractABI, signer);
    }
    /**
     * Create a new bounty
     * Validates parameters and submits transaction
     */
    async createBounty(params, options) {
        // Validation (business logic)
        this.validateCreateBountyParams(params);
        try {
            // Prepare transaction
            const tx = await this.contract.createBounty(params.requirementsHash, params.deadline, params.minRepRequired, params.maxRevisions || types_1.DEFAULT_MAX_REVISIONS, params.reviewPeriod || types_1.DEFAULT_REVIEW_PERIOD, {
                value: params.escrowAmount,
                ...options,
            });
            // Wait for confirmation
            const receipt = await tx.wait();
            // Extract bounty ID from event
            const event = receipt.logs.find((log) => log.fragment?.name === 'BountyCreated');
            if (!event) {
                throw new types_1.ContractError('BountyCreated event not found');
            }
            const bountyId = event.args[0];
            return {
                bountyId,
                txHash: receipt.hash,
            };
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    /**
     * Claim a bounty
     * Checks reputation requirements before submission
     */
    async claimBounty(bountyId, options) {
        try {
            const tx = await this.contract.claimBounty(bountyId, options);
            const receipt = await tx.wait();
            return { txHash: receipt.hash };
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    /**
     * Cancel a bounty
     * Only client can cancel if no submissions
     */
    async cancelBounty(bountyId, options) {
        try {
            const tx = await this.contract.cancelBounty(bountyId, options);
            const receipt = await tx.wait();
            return { txHash: receipt.hash };
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    /**
     * Get bounty details
     * Read-only operation
     */
    async getBounty(bountyId) {
        try {
            const bounty = await this.contract.getBounty(bountyId);
            return {
                bountyId: bounty.bountyId,
                client: bounty.client,
                minRepRequired: bounty.minRepRequired,
                status: bounty.status,
                maxRevisions: bounty.maxRevisions,
                escrowAmount: bounty.escrowAmount,
                platformFee: bounty.platformFee,
                deadline: bounty.deadline,
                createdAt: bounty.createdAt,
                reviewPeriod: bounty.reviewPeriod,
                requirementsHash: bounty.requirementsHash,
            };
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    /**
     * Get active bounty count for user
     * Read-only operation
     */
    async getActiveBountyCount(address) {
        try {
            const count = await this.contract.getActiveBountyCount(address);
            return Number(count);
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    /**
     * Check if user can claim bounty
     * Business logic validation
     */
    async canClaimBounty(bountyId, userAddress, userReputation, userTier, activeBountyCount) {
        try {
            const bounty = await this.getBounty(bountyId);
            // Check status
            if (bounty.status !== types_1.BountyStatus.Open) {
                return { canClaim: false, reason: 'Bounty is not open' };
            }
            // Check reputation requirement
            if (userReputation < bounty.minRepRequired) {
                return {
                    canClaim: false,
                    reason: `Insufficient reputation: ${userReputation}/${bounty.minRepRequired}`,
                };
            }
            // Check capacity limit (tier-based)
            const maxConcurrent = this.getMaxConcurrentBounties(userTier);
            if (activeBountyCount >= maxConcurrent) {
                return {
                    canClaim: false,
                    reason: `Capacity limit reached: ${activeBountyCount}/${maxConcurrent}`,
                };
            }
            // Check bounty value limit (tier-based)
            const maxBountyValue = this.getMaxBountyValue(userTier);
            if (bounty.escrowAmount > maxBountyValue) {
                return {
                    canClaim: false,
                    reason: `Bounty value exceeds tier limit`,
                };
            }
            return { canClaim: true };
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    /**
     * Estimate gas for creating bounty
     * Utility function
     */
    async estimateCreateBountyGas(params) {
        try {
            return await this.contract.createBounty.estimateGas(params.requirementsHash, params.deadline, params.minRepRequired, params.maxRevisions || types_1.DEFAULT_MAX_REVISIONS, params.reviewPeriod || types_1.DEFAULT_REVIEW_PERIOD, { value: params.escrowAmount });
        }
        catch (error) {
            throw this.handleContractError(error);
        }
    }
    // ============ VALIDATION (Business Logic) ============
    validateCreateBountyParams(params) {
        // Validate escrow amount
        if (params.escrowAmount < types_1.MIN_ESCROW_AMOUNT) {
            throw new types_1.ValidationError(`Escrow amount too low: minimum ${ethers_1.ethers.formatEther(types_1.MIN_ESCROW_AMOUNT)} ETH`);
        }
        // Validate deadline
        const now = BigInt(Math.floor(Date.now() / 1000));
        if (params.deadline <= now) {
            throw new types_1.ValidationError('Deadline must be in the future');
        }
        // Validate min reputation
        if (params.minRepRequired < 0 || params.minRepRequired > 100) {
            throw new types_1.ValidationError('Min reputation must be between 0 and 100');
        }
        // Validate review period
        if (params.reviewPeriod && params.reviewPeriod > BigInt(types_1.MAX_REVIEW_PERIOD)) {
            throw new types_1.ValidationError(`Review period too long: maximum ${types_1.MAX_REVIEW_PERIOD / 86400} days`);
        }
        // Validate requirements hash
        if (!params.requirementsHash || params.requirementsHash.length !== 66) {
            throw new types_1.ValidationError('Invalid requirements hash');
        }
    }
    // ============ TIER LIMITS (Business Logic) ============
    getMaxConcurrentBounties(tier) {
        switch (tier) {
            case 0: return 2; // Bronze
            case 1: return 5; // Silver
            case 2: return 10; // Gold
            case 3: return 20; // Platinum
            default: return 0;
        }
    }
    getMaxBountyValue(tier) {
        switch (tier) {
            case 0: return ethers_1.ethers.parseEther('500'); // Bronze
            case 1: return ethers_1.ethers.parseEther('2500'); // Silver
            case 2: return ethers_1.ethers.parseEther('10000'); // Gold
            case 3: return ethers_1.ethers.MaxUint256; // Platinum
            default: return 0n;
        }
    }
    // ============ ERROR HANDLING ============
    handleContractError(error) {
        if (error.code === 'CALL_EXCEPTION') {
            // Parse custom error
            const errorName = error.errorName || 'Unknown';
            return new types_1.ContractError(`Contract error: ${errorName}`, error);
        }
        if (error.code === 'INSUFFICIENT_FUNDS') {
            return new types_1.ContractError('Insufficient funds for transaction', error);
        }
        if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
            return new types_1.ContractError('Transaction would fail', error);
        }
        return error instanceof Error ? error : new types_1.ContractError('Unknown error', error);
    }
}
exports.BountyService = BountyService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQm91bnR5U2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXJ2aWNlcy9Cb3VudHlTZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG1DQUFrRDtBQUNsRCxvQ0FZa0I7QUFFbEI7OztHQUdHO0FBQ0gsTUFBYSxhQUFhO0lBSXRCLFlBQ1ksTUFBYyxFQUN0QixNQUFjLEVBQ2QsV0FBa0I7UUFGVixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBSXRCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxpQkFBUSxDQUN4QixNQUFNLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFDL0IsV0FBVyxFQUNYLE1BQU0sQ0FDVCxDQUFDO0lBQ04sQ0FBQztJQUVEOzs7T0FHRztJQUNILEtBQUssQ0FBQyxZQUFZLENBQ2QsTUFBMEIsRUFDMUIsT0FBNEI7UUFFNUIsOEJBQThCO1FBQzlCLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUM7WUFDRCxzQkFBc0I7WUFDdEIsTUFBTSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FDdkMsTUFBTSxDQUFDLGdCQUFnQixFQUN2QixNQUFNLENBQUMsUUFBUSxFQUNmLE1BQU0sQ0FBQyxjQUFjLEVBQ3JCLE1BQU0sQ0FBQyxZQUFZLElBQUksNkJBQXFCLEVBQzVDLE1BQU0sQ0FBQyxZQUFZLElBQUksNkJBQXFCLEVBQzVDO2dCQUNJLEtBQUssRUFBRSxNQUFNLENBQUMsWUFBWTtnQkFDMUIsR0FBRyxPQUFPO2FBQ2IsQ0FDSixDQUFDO1lBRUYsd0JBQXdCO1lBQ3hCLE1BQU0sT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDO1lBRWhDLCtCQUErQjtZQUMvQixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElB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LHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFFRCxPQUFPLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxxQkFBYSxDQUFDLGVBQWUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUN0RixDQUFDO0NBQ0o7QUE3UkQsc0NBNlJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXRoZXJzLCBDb250cmFjdCwgU2lnbmVyIH0gZnJvbSAnZXRoZXJzJztcclxuaW1wb3J0IHtcclxuICAgIENvbmZpZyxcclxuICAgIEJvdW50eSxcclxuICAgIENyZWF0ZUJvdW50eVBhcmFtcyxcclxuICAgIFRyYW5zYWN0aW9uT3B0aW9ucyxcclxuICAgIEJvdW50eVN0YXR1cyxcclxuICAgIENvbnRyYWN0RXJyb3IsXHJcbiAgICBWYWxpZGF0aW9uRXJyb3IsXHJcbiAgICBNSU5fRVNDUk9XX0FNT1VOVCxcclxuICAgIE1BWF9SRVZJRVdfUEVSSU9ELFxyXG4gICAgREVGQVVMVF9SRVZJRVdfUEVSSU9ELFxyXG4gICAgREVGQVVMVF9NQVhfUkVWSVNJT05TLFxyXG59IGZyb20gJy4uL3R5cGVzJztcclxuXHJcbi8qKlxyXG4gKiBCb3VudHlTZXJ2aWNlIC0gQnVzaW5lc3MgbG9naWMgZm9yIGJvdW50eSBvcGVyYXRpb25zXHJcbiAqIE5vIFVJIGxvZ2ljLCBvbmx5IGNvbnRyYWN0IGludGVyYWN0aW9ucyBhbmQgdmFsaWRhdGlvblxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEJvdW50eVNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSBjb250cmFjdDogQ29udHJhY3Q7XHJcbiAgICBwcml2YXRlIHNpZ25lcjogU2lnbmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgY29uZmlnOiBDb25maWcsXHJcbiAgICAgICAgc2lnbmVyOiBTaWduZXIsXHJcbiAgICAgICAgY29udHJhY3RBQkk6IGFueVtdXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLnNpZ25lciA9IHNpZ25lcjtcclxuICAgICAgICB0aGlzLmNvbnRyYWN0ID0gbmV3IENvbnRyYWN0KFxyXG4gICAgICAgICAgICBjb25maWcuY29udHJhY3RzLmJvdW50eVJlZ2lzdHJ5LFxyXG4gICAgICAgICAgICBjb250cmFjdEFCSSxcclxuICAgICAgICAgICAgc2lnbmVyXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENyZWF0ZSBhIG5ldyBib3VudHlcclxuICAgICAqIFZhbGlkYXRlcyBwYXJhbWV0ZXJzIGFuZCBzdWJtaXRzIHRyYW5zYWN0aW9uXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGNyZWF0ZUJvdW50eShcclxuICAgICAgICBwYXJhbXM6IENyZWF0ZUJvdW50eVBhcmFtcyxcclxuICAgICAgICBvcHRpb25zPzogVHJhbnNhY3Rpb25PcHRpb25zXHJcbiAgICApOiBQcm9taXNlPHsgYm91bnR5SWQ6IGJpZ2ludDsgdHhIYXNoOiBzdHJpbmcgfT4ge1xyXG4gICAgICAgIC8vIFZhbGlkYXRpb24gKGJ1c2luZXNzIGxvZ2ljKVxyXG4gICAgICAgIHRoaXMudmFsaWRhdGVDcmVhdGVCb3VudHlQYXJhbXMocGFyYW1zKTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgLy8gUHJlcGFyZSB0cmFuc2FjdGlvblxyXG4gICAgICAgICAgICBjb25zdCB0eCA9IGF3YWl0IHRoaXMuY29udHJhY3QuY3JlYXRlQm91bnR5KFxyXG4gICAgICAgICAgICAgICAgcGFyYW1zLnJlcXVpcmVtZW50c0hhc2gsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXMuZGVhZGxpbmUsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXMubWluUmVwUmVxdWlyZWQsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXMubWF4UmV2aXNpb25zIHx8IERFRkFVTFRfTUFYX1JFVklTSU9OUyxcclxuICAgICAgICAgICAgICAgIHBhcmFtcy5yZXZpZXdQZXJpb2QgfHwgREVGQVVMVF9SRVZJRVdfUEVSSU9ELFxyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwYXJhbXMuZXNjcm93QW1vdW50LFxyXG4gICAgICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICAvLyBXYWl0IGZvciBjb25maXJtYXRpb25cclxuICAgICAgICAgICAgY29uc3QgcmVjZWlwdCA9IGF3YWl0IHR4LndhaXQoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIEV4dHJhY3QgYm91bnR5IElEIGZyb20gZXZlbnRcclxuICAgICAgICAgICAgY29uc3QgZXZlbnQgPSByZWNlaXB0LmxvZ3MuZmluZChcclxuICAgICAgICAgICAgICAgIChsb2c6IGFueSkgPT4gbG9nLmZyYWdtZW50Py5uYW1lID09PSAnQm91bnR5Q3JlYXRlZCdcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBDb250cmFjdEVycm9yKCdCb3VudHlDcmVhdGVkIGV2ZW50IG5vdCBmb3VuZCcpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBib3VudHlJZCA9IGV2ZW50LmFyZ3NbMF07XHJcblxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgYm91bnR5SWQsXHJcbiAgICAgICAgICAgICAgICB0eEhhc2g6IHJlY2VpcHQuaGFzaCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyB0aGlzLmhhbmRsZUNvbnRyYWN0RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENsYWltIGEgYm91bnR5XHJcbiAgICAgKiBDaGVja3MgcmVwdXRhdGlvbiByZXF1aXJlbWVudHMgYmVmb3JlIHN1Ym1pc3Npb25cclxuICAgICAqL1xyXG4gICAgYXN5bmMgY2xhaW1Cb3VudHkoXHJcbiAgICAgICAgYm91bnR5SWQ6IGJpZ2ludCxcclxuICAgICAgICBvcHRpb25zPzogVHJhbnNhY3Rpb25PcHRpb25zXHJcbiAgICApOiBQcm9taXNlPHsgdHhIYXNoOiBzdHJpbmcgfT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR4ID0gYXdhaXQgdGhpcy5jb250cmFjdC5jbGFpbUJvdW50eShib3VudHlJZCwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCB0eC53YWl0KCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4geyB0eEhhc2g6IHJlY2VpcHQuaGFzaCB9O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IHRoaXMuaGFuZGxlQ29udHJhY3RFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQ2FuY2VsIGEgYm91bnR5XHJcbiAgICAgKiBPbmx5IGNsaWVudCBjYW4gY2FuY2VsIGlmIG5vIHN1Ym1pc3Npb25zXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGNhbmNlbEJvdW50eShcclxuICAgICAgICBib3VudHlJZDogYmlnaW50LFxyXG4gICAgICAgIG9wdGlvbnM/OiBUcmFuc2FjdGlvbk9wdGlvbnNcclxuICAgICk6IFByb21pc2U8eyB0eEhhc2g6IHN0cmluZyB9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgdHggPSBhd2FpdCB0aGlzLmNvbnRyYWN0LmNhbmNlbEJvdW50eShib3VudHlJZCwgb3B0aW9ucyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlY2VpcHQgPSBhd2FpdCB0eC53YWl0KCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4geyB0eEhhc2g6IHJlY2VpcHQuaGFzaCB9O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IHRoaXMuaGFuZGxlQ29udHJhY3RFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogR2V0IGJvdW50eSBkZXRhaWxzXHJcbiAgICAgKiBSZWFkLW9ubHkgb3BlcmF0aW9uXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGdldEJvdW50eShib3VudHlJZDogYmlnaW50KTogUHJvbWlzZTxCb3VudHk+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBib3VudHkgPSBhd2FpdCB0aGlzLmNvbnRyYWN0LmdldEJvdW50eShib3VudHlJZCk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgYm91bnR5SWQ6IGJvdW50eS5ib3VudHlJZCxcclxuICAgICAgICAgICAgICAgIGNsaWVudDogYm91bnR5LmNsaWVudCxcclxuICAgICAgICAgICAgICAgIG1pblJlcFJlcXVpcmVkOiBib3VudHkubWluUmVwUmVxdWlyZWQsXHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IGJvdW50eS5zdGF0dXMgYXMgQm91bnR5U3RhdHVzLFxyXG4gICAgICAgICAgICAgICAgbWF4UmV2aXNpb25zOiBib3VudHkubWF4UmV2aXNpb25zLFxyXG4gICAgICAgICAgICAgICAgZXNjcm93QW1vdW50OiBib3VudHkuZXNjcm93QW1vdW50LFxyXG4gICAgICAgICAgICAgICAgcGxhdGZvcm1GZWU6IGJvdW50eS5wbGF0Zm9ybUZlZSxcclxuICAgICAgICAgICAgICAgIGRlYWRsaW5lOiBib3VudHkuZGVhZGxpbmUsXHJcbiAgICAgICAgICAgICAgICBjcmVhdGVkQXQ6IGJvdW50eS5jcmVhdGVkQXQsXHJcbiAgICAgICAgICAgICAgICByZXZpZXdQZXJpb2Q6IGJvdW50eS5yZXZpZXdQZXJpb2QsXHJcbiAgICAgICAgICAgICAgICByZXF1aXJlbWVudHNIYXNoOiBib3VudHkucmVxdWlyZW1lbnRzSGFzaCxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyB0aGlzLmhhbmRsZUNvbnRyYWN0RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEdldCBhY3RpdmUgYm91bnR5IGNvdW50IGZvciB1c2VyXHJcbiAgICAgKiBSZWFkLW9ubHkgb3BlcmF0aW9uXHJcbiAgICAgKi9cclxuICAgIGFzeW5jIGdldEFjdGl2ZUJvdW50eUNvdW50KGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgY291bnQgPSBhd2FpdCB0aGlzLmNvbnRyYWN0LmdldEFjdGl2ZUJvdW50eUNvdW50KGFkZHJlc3MpO1xyXG4gICAgICAgICAgICByZXR1cm4gTnVtYmVyKGNvdW50KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyB0aGlzLmhhbmRsZUNvbnRyYWN0RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENoZWNrIGlmIHVzZXIgY2FuIGNsYWltIGJvdW50eVxyXG4gICAgICogQnVzaW5lc3MgbG9naWMgdmFsaWRhdGlvblxyXG4gICAgICovXHJcbiAgICBhc3luYyBjYW5DbGFpbUJvdW50eShcclxuICAgICAgICBib3VudHlJZDogYmlnaW50LFxyXG4gICAgICAgIHVzZXJBZGRyZXNzOiBzdHJpbmcsXHJcbiAgICAgICAgdXNlclJlcHV0YXRpb246IG51bWJlcixcclxuICAgICAgICB1c2VyVGllcjogbnVtYmVyLFxyXG4gICAgICAgIGFjdGl2ZUJvdW50eUNvdW50OiBudW1iZXJcclxuICAgICk6IFByb21pc2U8eyBjYW5DbGFpbTogYm9vbGVhbjsgcmVhc29uPzogc3RyaW5nIH0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBib3VudHkgPSBhd2FpdCB0aGlzLmdldEJvdW50eShib3VudHlJZCk7XHJcblxyXG4gICAgICAgICAgICAvLyBDaGVjayBzdGF0dXNcclxuICAgICAgICAgICAgaWYgKGJvdW50eS5zdGF0dXMgIT09IEJvdW50eVN0YXR1cy5PcGVuKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjYW5DbGFpbTogZmFsc2UsIHJlYXNvbjogJ0JvdW50eSBpcyBub3Qgb3BlbicgfTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgcmVwdXRhdGlvbiByZXF1aXJlbWVudFxyXG4gICAgICAgICAgICBpZiAodXNlclJlcHV0YXRpb24gPCBib3VudHkubWluUmVwUmVxdWlyZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FuQ2xhaW06IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlYXNvbjogYEluc3VmZmljaWVudCByZXB1dGF0aW9uOiAke3VzZXJSZXB1dGF0aW9ufS8ke2JvdW50eS5taW5SZXBSZXF1aXJlZH1gLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgLy8gQ2hlY2sgY2FwYWNpdHkgbGltaXQgKHRpZXItYmFzZWQpXHJcbiAgICAgICAgICAgIGNvbnN0IG1heENvbmN1cnJlbnQgPSB0aGlzLmdldE1heENvbmN1cnJlbnRCb3VudGllcyh1c2VyVGllcik7XHJcbiAgICAgICAgICAgIGlmIChhY3RpdmVCb3VudHlDb3VudCA+PSBtYXhDb25jdXJyZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhbkNsYWltOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICByZWFzb246IGBDYXBhY2l0eSBsaW1pdCByZWFjaGVkOiAke2FjdGl2ZUJvdW50eUNvdW50fS8ke21heENvbmN1cnJlbnR9YCxcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIENoZWNrIGJvdW50eSB2YWx1ZSBsaW1pdCAodGllci1iYXNlZClcclxuICAgICAgICAgICAgY29uc3QgbWF4Qm91bnR5VmFsdWUgPSB0aGlzLmdldE1heEJvdW50eVZhbHVlKHVzZXJUaWVyKTtcclxuICAgICAgICAgICAgaWYgKGJvdW50eS5lc2Nyb3dBbW91bnQgPiBtYXhCb3VudHlWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBjYW5DbGFpbTogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgcmVhc29uOiBgQm91bnR5IHZhbHVlIGV4Y2VlZHMgdGllciBsaW1pdGAsXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4geyBjYW5DbGFpbTogdHJ1ZSB9O1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IHRoaXMuaGFuZGxlQ29udHJhY3RFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogRXN0aW1hdGUgZ2FzIGZvciBjcmVhdGluZyBib3VudHlcclxuICAgICAqIFV0aWxpdHkgZnVuY3Rpb25cclxuICAgICAqL1xyXG4gICAgYXN5bmMgZXN0aW1hdGVDcmVhdGVCb3VudHlHYXMocGFyYW1zOiBDcmVhdGVCb3VudHlQYXJhbXMpOiBQcm9taXNlPGJpZ2ludD4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNvbnRyYWN0LmNyZWF0ZUJvdW50eS5lc3RpbWF0ZUdhcyhcclxuICAgICAgICAgICAgICAgIHBhcmFtcy5yZXF1aXJlbWVudHNIYXNoLFxyXG4gICAgICAgICAgICAgICAgcGFyYW1zLmRlYWRsaW5lLFxyXG4gICAgICAgICAgICAgICAgcGFyYW1zLm1pblJlcFJlcXVpcmVkLFxyXG4gICAgICAgICAgICAgICAgcGFyYW1zLm1heFJldmlzaW9ucyB8fCBERUZBVUxUX01BWF9SRVZJU0lPTlMsXHJcbiAgICAgICAgICAgICAgICBwYXJhbXMucmV2aWV3UGVyaW9kIHx8IERFRkFVTFRfUkVWSUVXX1BFUklPRCxcclxuICAgICAgICAgICAgICAgIHsgdmFsdWU6IHBhcmFtcy5lc2Nyb3dBbW91bnQgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IHRoaXMuaGFuZGxlQ29udHJhY3RFcnJvcihlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vID09PT09PT09PT09PSBWQUxJREFUSU9OIChCdXNpbmVzcyBMb2dpYykgPT09PT09PT09PT09XHJcblxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0ZUNyZWF0ZUJvdW50eVBhcmFtcyhwYXJhbXM6IENyZWF0ZUJvdW50eVBhcmFtcyk6IHZvaWQge1xyXG4gICAgICAgIC8vIFZhbGlkYXRlIGVzY3JvdyBhbW91bnRcclxuICAgICAgICBpZiAocGFyYW1zLmVzY3Jvd0Ftb3VudCA8IE1JTl9FU0NST1dfQU1PVU5UKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgRXNjcm93IGFtb3VudCB0b28gbG93OiBtaW5pbXVtICR7ZXRoZXJzLmZvcm1hdEV0aGVyKE1JTl9FU0NST1dfQU1PVU5UKX0gRVRIYFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVmFsaWRhdGUgZGVhZGxpbmVcclxuICAgICAgICBjb25zdCBub3cgPSBCaWdJbnQoTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCkpO1xyXG4gICAgICAgIGlmIChwYXJhbXMuZGVhZGxpbmUgPD0gbm93KSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoJ0RlYWRsaW5lIG11c3QgYmUgaW4gdGhlIGZ1dHVyZScpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVmFsaWRhdGUgbWluIHJlcHV0YXRpb25cclxuICAgICAgICBpZiAocGFyYW1zLm1pblJlcFJlcXVpcmVkIDwgMCB8fCBwYXJhbXMubWluUmVwUmVxdWlyZWQgPiAxMDApIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcignTWluIHJlcHV0YXRpb24gbXVzdCBiZSBiZXR3ZWVuIDAgYW5kIDEwMCcpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVmFsaWRhdGUgcmV2aWV3IHBlcmlvZFxyXG4gICAgICAgIGlmIChwYXJhbXMucmV2aWV3UGVyaW9kICYmIHBhcmFtcy5yZXZpZXdQZXJpb2QgPiBCaWdJbnQoTUFYX1JFVklFV19QRVJJT0QpKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgUmV2aWV3IHBlcmlvZCB0b28gbG9uZzogbWF4aW11bSAke01BWF9SRVZJRVdfUEVSSU9EIC8gODY0MDB9IGRheXNgXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBWYWxpZGF0ZSByZXF1aXJlbWVudHMgaGFzaFxyXG4gICAgICAgIGlmICghcGFyYW1zLnJlcXVpcmVtZW50c0hhc2ggfHwgcGFyYW1zLnJlcXVpcmVtZW50c0hhc2gubGVuZ3RoICE9PSA2Nikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKCdJbnZhbGlkIHJlcXVpcmVtZW50cyBoYXNoJyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vID09PT09PT09PT09PSBUSUVSIExJTUlUUyAoQnVzaW5lc3MgTG9naWMpID09PT09PT09PT09PVxyXG5cclxuICAgIHByaXZhdGUgZ2V0TWF4Q29uY3VycmVudEJvdW50aWVzKHRpZXI6IG51bWJlcik6IG51bWJlciB7XHJcbiAgICAgICAgc3dpdGNoICh0aWVyKSB7XHJcbiAgICAgICAgICAgIGNhc2UgMDogcmV0dXJuIDI7ICAvLyBCcm9uemVcclxuICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gNTsgIC8vIFNpbHZlclxyXG4gICAgICAgICAgICBjYXNlIDI6IHJldHVybiAxMDsgLy8gR29sZFxyXG4gICAgICAgICAgICBjYXNlIDM6IHJldHVybiAyMDsgLy8gUGxhdGludW1cclxuICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0TWF4Qm91bnR5VmFsdWUodGllcjogbnVtYmVyKTogYmlnaW50IHtcclxuICAgICAgICBzd2l0Y2ggKHRpZXIpIHtcclxuICAgICAgICAgICAgY2FzZSAwOiByZXR1cm4gZXRoZXJzLnBhcnNlRXRoZXIoJzUwMCcpOyAgICAvLyBCcm9uemVcclxuICAgICAgICAgICAgY2FzZSAxOiByZXR1cm4gZXRoZXJzLnBhcnNlRXRoZXIoJzI1MDAnKTsgICAvLyBTaWx2ZXJcclxuICAgICAgICAgICAgY2FzZSAyOiByZXR1cm4gZXRoZXJzLnBhcnNlRXRoZXIoJzEwMDAwJyk7ICAvLyBHb2xkXHJcbiAgICAgICAgICAgIGNhc2UgMzogcmV0dXJuIGV0aGVycy5NYXhVaW50MjU2OyAgICAgICAgICAgLy8gUGxhdGludW1cclxuICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIDBuO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyA9PT09PT09PT09PT0gRVJST1IgSEFORExJTkcgPT09PT09PT09PT09XHJcblxyXG4gICAgcHJpdmF0ZSBoYW5kbGVDb250cmFjdEVycm9yKGVycm9yOiBhbnkpOiBFcnJvciB7XHJcbiAgICAgICAgaWYgKGVycm9yLmNvZGUgPT09ICdDQUxMX0VYQ0VQVElPTicpIHtcclxuICAgICAgICAgICAgLy8gUGFyc2UgY3VzdG9tIGVycm9yXHJcbiAgICAgICAgICAgIGNvbnN0IGVycm9yTmFtZSA9IGVycm9yLmVycm9yTmFtZSB8fCAnVW5rbm93bic7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29udHJhY3RFcnJvcihgQ29udHJhY3QgZXJyb3I6ICR7ZXJyb3JOYW1lfWAsIGVycm9yKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChlcnJvci5jb2RlID09PSAnSU5TVUZGSUNJRU5UX0ZVTkRTJykge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IENvbnRyYWN0RXJyb3IoJ0luc3VmZmljaWVudCBmdW5kcyBmb3IgdHJhbnNhY3Rpb24nLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoZXJyb3IuY29kZSA9PT0gJ1VOUFJFRElDVEFCTEVfR0FTX0xJTUlUJykge1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IENvbnRyYWN0RXJyb3IoJ1RyYW5zYWN0aW9uIHdvdWxkIGZhaWwnLCBlcnJvcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IENvbnRyYWN0RXJyb3IoJ1Vua25vd24gZXJyb3InLCBlcnJvcik7XHJcbiAgICB9XHJcbn1cclxuIl19